image: registry.gitlab.com/notify-messenger/smartpass-frontend/ci-image:12.22.10

variables:
  NVM_DIR: /root/.nvm

cache:
  key:
    files:
      - yarn.lock
  paths:
    - node_modules/
    - .yarn/

stages:
  - build
  - deploy
  - e2e

build:
  stage: build
  script:
    - yarn install
    - yarn run lint:ci
    - scripts/cf_build.sh
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'master'
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - dist/
  interruptible: true
  tags:
    - "docker-passthrough"

mr_preview_deploy:
  stage: deploy
  variables:
    CLOUDFLARE_ACCOUNT_ID: 5f14bf10d9d1edfa1aaefaaa7854e9f6
    CLOUDFLARE_API_TOKEN: $CLOUDFLARE_PAGES_TOKEN
  script:
    # wrangler was installed when the ci-image docker image was created
    - chmod a+x $NVM_DIR/nvm.sh
    - . $NVM_DIR/nvm.sh
    - nvm use lts/hydrogen
    - wrangler pages publish dist --project-name=smartpass-frontend --branch $CI_COMMIT_REF_NAME
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  interruptible: true
  needs: [build]
  tags:
    - "docker-passthrough"


deploy:
  stage: deploy
  variables:
    CLOUDFLARE_ACCOUNT_ID: 5f14bf10d9d1edfa1aaefaaa7854e9f6
    CLOUDFLARE_API_TOKEN: $CLOUDFLARE_PAGES_TOKEN
  script:
    # wrangler was installed when the ci-image docker image was created
    - chmod a+x $NVM_DIR/nvm.sh
    - . $NVM_DIR/nvm.sh
    - nvm use lts/hydrogen
    - wrangler pages publish dist --project-name=smartpass-frontend --branch master
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
      when: manual
      allow_failure: true
  needs: [build]
  tags:
    - "docker-passthrough"

e2e:
  stage: e2e
  image: cypress/browsers:node12.19.0-chrome86-ff82
  script:
    - yarn install
    - yarn run e2e:ci
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
  interruptible: true
  dependencies: []
  tags:
    - "docker-passthrough"
