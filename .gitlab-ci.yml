image: docker:latest

variables:
  # AUTO_DEVOPS_DOMAIN is the application deployment domain and should be set as a variable at the group or project level.
  # AUTO_DEVOPS_DOMAIN: notify-messenger-notify-server-staging.lavanote.com
  # AUTO_DEVOPS_DOMAIN: smartpass.app

  KUBERNETES_VERSION: 1.10.3
  HELM_VERSION: 2.9.1
  SENTRY_ORG: "smartpass"
  SENTRY_PROJECT: "hall-pass-web"

stages:
  - deploy_staging
  - deploy_prod

testing:
  stage: deploy_staging
  script:
    - apk add --no-cache bash tree nodejs yarn
    - "wget 'https://github.com/getsentry/sentry-cli/releases/download/1.37.4/sentry-cli-Linux-x86_64' -O /usr/local/bin/sentry-cli"
    - chmod +x /usr/local/bin/sentry-cli
    - ls -l / ; pwd
    - "[ -d /mem_fs ] && cp -r /notify-messenger/hall-pass-web /mem_fs/hall-pass-web && cd /mem_fs/hall-pass-web || echo 'Not using mem disk!'"
    - pwd
    - source scripts/auto_devops.sh
    - scripts/build.sh
    - install_dependencies
    - download_chart
    - ensure_namespace
    - install_tiller
    - create_secret
    - deploy
  variables:
    AUTO_DEVOPS_DOMAIN: "smartpass-testing.lavanote.com"
    IMAGE_TAG_SUFFIX: "testing"
  environment:
    name: testing
    url: "https://smartpass-testing.lavanote.com"
  only:
    refs:
      - "next-release"
    kubernetes: active
  tags:
    - "docker-passthrough"

staging:
  stage: deploy_staging
  script:
    - apk add --no-cache bash tree nodejs yarn
    - "wget 'https://github.com/getsentry/sentry-cli/releases/download/1.37.4/sentry-cli-Linux-x86_64' -O /usr/local/bin/sentry-cli"
    - chmod +x /usr/local/bin/sentry-cli
    - ls -l / ; pwd
    - "[ -d /mem_fs ] && cp -r /notify-messenger/hall-pass-web /mem_fs/hall-pass-web && cd /mem_fs/hall-pass-web || echo 'Not using mem disk!'"
    - pwd
    - source scripts/auto_devops.sh
    - scripts/build.sh
    - install_dependencies
    - download_chart
    - ensure_namespace
    - install_tiller
    - create_secret
    - deploy
  variables:
    AUTO_DEVOPS_DOMAIN: "notify-messenger-notify-server-staging.lavanote.com"
    IMAGE_TAG_SUFFIX: "production"
  environment:
      name: staging
      url: "https://notify-messenger-notify-server-staging.lavanote.com"
  only:
    refs:
      - master
    kubernetes: active
  tags:
      - "docker-passthrough"

production:
  stage: deploy_prod
  script:
  - apk add --no-cache bash tree nodejs yarn
  - source scripts/auto_devops.sh
  # no build command. This causes it to reuse the pre-built images from staging because IMAGE_TAG_SUFFIX is shared.
  - install_dependencies
  - download_chart
  - ensure_namespace
  - install_tiller
  - create_secret
  - deploy
  variables:
    AUTO_DEVOPS_DOMAIN: "smartpass.app"
    IMAGE_TAG_SUFFIX: "production"
  environment:
    name: production
    url: "https://smartpass.app"
  when: manual
  only:
    refs:
    - master
    kubernetes: active
  tags:
  - "docker-passthrough"


staging_local:
  stage: deploy_prod
  script:
    - apk add --no-cache bash tree nodejs yarn
    - "wget 'https://github.com/getsentry/sentry-cli/releases/download/1.37.4/sentry-cli-Linux-x86_64' -O /usr/local/bin/sentry-cli"
    - chmod +x /usr/local/bin/sentry-cli
    - ls -l / ; pwd
    - "[ -d /mem_fs ] && cp -r /notify-messenger/hall-pass-web /mem_fs/hall-pass-web && cd /mem_fs/hall-pass-web || echo 'Not using mem disk!'"
    - pwd
    - source scripts/auto_devops.sh
    - scripts/build.sh
    - install_dependencies
    - download_chart
    - ensure_namespace
    - install_tiller
    - create_secret
    - deploy
  variables:
    AUTO_DEVOPS_DOMAIN: "smartpass-local.lavanote.com"
    IMAGE_TAG_SUFFIX: "production-local"
  environment:
    name: local
    url: "https://smartpass-local.lavanote.com"
  when: manual
  only:
    refs:
      - master
    kubernetes: active
  tags:
    - "docker-passthrough"
