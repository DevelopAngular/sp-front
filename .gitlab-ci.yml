image: docker:latest

variables:
  # AUTO_DEVOPS_DOMAIN is the application deployment domain and should be set as a variable at the group or project level.
  # AUTO_DEVOPS_DOMAIN: notify-messenger-notify-server-staging.lavanote.com
  AUTO_DEVOPS_DOMAIN: smartpass.app

  KUBERNETES_VERSION: 1.10.3
  HELM_VERSION: 2.9.1

stages:
  - build

staging:
  stage: build
  script:
    - apk add --no-cache bash tree nodejs-npm
    - source scripts/auto_devops.sh
    - scripts/build.sh
    - check_kube_domain
    - install_dependencies
    - download_chart
    - ensure_namespace
    - install_tiller
    - create_secret
    - deploy
  environment:
      name: staging
      url: $AUTO_DEVOPS_DOMAIN
  only:
    refs:
      - dev
    kubernetes: active
  tags:
      - "docker-passthrough"
