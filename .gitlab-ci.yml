image: registry.gitlab.com/notify-messenger/smartpass-frontend/ci-image:12.22.10

variables:
  NVM_DIR: /root/.nvm

cache:
  key:
    files:
      - yarn.lock
  paths:
    - node_modules/
    - .yarn/

stages:
  - build
  - deploy
  - e2e

build:
  stage: build
  script:
    - yarn install
    - yarn run lint:ci
    - scripts/cf_build.sh
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'master'
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - dist/
  interruptible: true
  tags:
    - "docker-passthrough"

mr_preview_deploy:
  stage: deploy
  variables:
    CLOUDFLARE_ACCOUNT_ID: 5f14bf10d9d1edfa1aaefaaa7854e9f6
    CLOUDFLARE_API_TOKEN: $CLOUDFLARE_PAGES_TOKEN
  script:
    # wrangler was installed when the ci-image docker image was created
    - chmod a+x $NVM_DIR/nvm.sh
    - . $NVM_DIR/nvm.sh
    - nvm use lts/hydrogen
    - wrangler pages publish dist --project-name=smartpass-frontend --branch $CI_COMMIT_REF_NAME
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  interruptible: true
  needs: [build]
  environment:
    name: preview/$CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_SLUG.smartpass-frontend.pages.dev
    on_stop: mr_preview_stop
    auto_stop_in: 1 week
  tags:
    - "docker-passthrough"

mr_preview_stop:
  stage: deploy
  needs: [mr_preview_deploy]
  environment:
      name: preview/$CI_COMMIT_REF_NAME
      action: stop
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      when: manual
  script:
    - |
      # Get the deployments list
      DEPLOYMENTS_URL="https://api.cloudflare.com/client/v4/accounts/5f14bf10d9d1edfa1aaefaaa7854e9f6/pages/projects/smartpass-frontend/deployments"
      DEPLOYMENTS=$(curl -s -H "Authorization: Bearer $CLOUDFLARE_PAGES_TOKEN" -H "Content-Type: application/json" ${DEPLOYMENTS_URL})

      # Extract deployment ID for the current environment
      COMMIT_REF_SLUG=$(echo $CI_COMMIT_REF_SLUG | sed 's/\//-/g') # Replace slashes with hyphens
      ALIAS="https://$COMMIT_REF_SLUG.smartpass-frontend.pages.dev"
      DEPLOYMENT_ID=$(echo ${DEPLOYMENTS} | jq -r --arg ALIAS "${ALIAS}" '.result[] | select(.aliases[0] == $ALIAS) | .id')

      if [ -z "${DEPLOYMENT_ID}" ]; then
        echo "Deployment ID not found for the current environment."
        exit 1
      fi

      # Delete the deployment
      DELETE_DEPLOYMENT_URL="https://api.cloudflare.com/client/v4/accounts/5f14bf10d9d1edfa1aaefaaa7854e9f6/pages/projects/smartpass-frontend/deployments/${DEPLOYMENT_ID}?force=true"
      curl -X DELETE -H "Authorization: Bearer $CLOUDFLARE_PAGES_TOKEN" -H "Content-Type: application/json" ${DELETE_DEPLOYMENT_URL}
  tags:
    - "docker-passthrough"

deploy:
  stage: deploy
  variables:
    CLOUDFLARE_ACCOUNT_ID: 5f14bf10d9d1edfa1aaefaaa7854e9f6
    CLOUDFLARE_API_TOKEN: $CLOUDFLARE_PAGES_TOKEN
  script:
    # wrangler was installed when the ci-image docker image was created
    - chmod a+x $NVM_DIR/nvm.sh
    - . $NVM_DIR/nvm.sh
    - nvm use lts/hydrogen
    - wrangler pages publish dist --project-name=smartpass-frontend --branch master
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
      when: manual
      allow_failure: true
  needs: [build]
  environment:
    name: production
    url: https://app.smartpass.app
  tags:
    - "docker-passthrough"

e2e:
  stage: e2e
  image: cypress/browsers:node12.19.0-chrome86-ff82
  script:
    - yarn install
    - yarn run e2e:ci
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
  interruptible: true
  dependencies: []
  tags:
    - "docker-passthrough"
